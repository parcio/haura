#!/bin/bash

# Script to extract median benchmark times from Criterion JSON output and create CSV files.
# Usage: ./extract_results_csv.sh <path/to/criterion/results>

if [ -z "$1" ]; then
    echo "Usage: ./extract_results <path/to/criterion/results>"
    echo "Please provide the path to the directory containing the criterion benchmark results."
    exit 1
fi

RESULTS_DIR="$1"

if [ ! -d "${RESULTS_DIR}" ]; then
    echo "Error: Results directory '${RESULTS_DIR}' not found."
    exit 1
fi

BENCHMARK_TYPES=("alloc" "new")
SEG_LOG_2_VALUES=({14..23})
ALLOCATORS=(
    "FirstFitList"
    "FirstFitScan"
    "FirstFitTree"
    "NextFitList"
    "NextFitScan"
    "BestFitList"
    "BestFitScan"
    "BestFitTree"
    "ApproximateBestFitTree"
    "WorstFitList"
    "WorstFitScan"
    "WorstFitTree"
    "SegmentAllocator"
    "HybridAllocator"
)

# Create CSV file headers
echo -e "SEGMENT_SIZE_LOG_2 ${ALLOCATORS[@]}" > alloc_benchmark_results.csv
echo -e "SEGMENT_SIZE_LOG_2 ${ALLOCATORS[@]}" > new_benchmark_results.csv

for benchmark_type in "${BENCHMARK_TYPES[@]}"; do
    csv_file="${benchmark_type}_benchmark_results.csv"
    for seg_log_2 in "${SEG_LOG_2_VALUES[@]}"; do
        line="${seg_log_2}"
        for allocator in "${ALLOCATORS[@]}"; do
            json_path="${RESULTS_DIR}/allocator_${benchmark_type}_zipfian_${seg_log_2}/${allocator}/new/estimates.json"

            if [ -f "${json_path}" ]; then
                median_value=$(jq '.median.point_estimate' "${json_path}" 2>/dev/null)
                if [ -n "$median_value" ]; then
                    line+=" ${median_value}"
                else
                    line+=" N/A"
                    echo "Warning: jq failed or no median value found in ${json_path}"
                fi
            else
                line+=" N/A"
                echo "Warning: JSON file not found: ${json_path}"
            fi
        done
        echo -e "${line}" >> "${csv_file}"
    done
done

echo "CSV files 'alloc_benchmark_results.csv' and 'new_benchmark_results.csv' created in the script directory."
